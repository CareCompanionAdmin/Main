{{define "layout.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - CareCompanion Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sidebar { min-height: calc(100vh - 64px); }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Top Navigation -->
    <nav class="bg-indigo-700 text-white shadow-lg">
        <div class="max-w-full mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-xl font-bold">CareCompanion Admin</span>
                    <span class="ml-2 px-2 py-1 text-xs bg-indigo-800 rounded">{{.CurrentUser.SystemRole}}</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span>{{.CurrentUser.FirstName}} ({{.CurrentUser.Email}})</span>
                    <a href="/admin/login" onclick="document.cookie='access_token=;path=/;expires=Thu, 01 Jan 1970 00:00:01 GMT';"
                       class="px-3 py-1 bg-indigo-800 rounded hover:bg-indigo-900">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex">
        <!-- Sidebar -->
        <aside class="sidebar w-64 bg-white shadow-md">
            <nav class="p-4">
                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Dashboard</h3>
                    <a href="/admin/dashboard" class="block px-3 py-2 rounded hover:bg-gray-100">Overview</a>
                </div>

                {{if or (eq .CurrentUser.SystemRole "super_admin") (eq .CurrentUser.SystemRole "support")}}
                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Support</h3>
                    <a href="/admin/tickets" class="block px-3 py-2 rounded hover:bg-gray-100 flex items-center justify-between">
                        <span>Tickets</span>
                        <span id="ticket-badge" class="hidden bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                    </a>
                    <a href="/admin/users" class="block px-3 py-2 rounded hover:bg-gray-100">Users</a>
                    <a href="/admin/families" class="block px-3 py-2 rounded hover:bg-gray-100">Families</a>
                </div>
                {{end}}

                {{if or (eq .CurrentUser.SystemRole "super_admin") (eq .CurrentUser.SystemRole "marketing")}}
                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Marketing</h3>
                    <a href="/admin/marketing" class="block px-3 py-2 rounded hover:bg-gray-100">Metrics Dashboard</a>
                    <a href="/admin/materials" class="block px-3 py-2 rounded hover:bg-gray-100">Copy & Materials</a>
                    {{if eq .CurrentUser.SystemRole "super_admin"}}
                    <a href="/admin/promo-codes" class="block px-3 py-2 rounded hover:bg-gray-100">Promo Codes</a>
                    {{else}}
                    <a href="/admin/marketing/tickets" class="block px-3 py-2 rounded hover:bg-gray-100">Tickets <span class="text-xs text-gray-400">(Read Only)</span></a>
                    <a href="/admin/promo-codes" class="block px-3 py-2 rounded hover:bg-gray-100">Promo Codes <span class="text-xs text-gray-400">(Read Only)</span></a>
                    {{end}}
                </div>
                {{end}}

                {{if eq .CurrentUser.SystemRole "super_admin"}}
                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">System</h3>
                    <a href="/admin/status" class="block px-3 py-2 rounded hover:bg-gray-100">Infrastructure Status</a>
                    <a href="/admin/errors" class="block px-3 py-2 rounded hover:bg-gray-100 flex items-center justify-between">
                        <span>Error Logs</span>
                        <span id="error-badge" class="hidden bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                    </a>
                    <a href="/admin/development" class="block px-3 py-2 rounded hover:bg-gray-100">Development Mode</a>
                </div>

                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Finance</h3>
                    <a href="/admin/financials" class="block px-3 py-2 rounded hover:bg-gray-100">Financials</a>
                </div>

                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Administration</h3>
                    <a href="/admin/admins" class="block px-3 py-2 rounded hover:bg-gray-100">Admin Users</a>
                    <a href="/admin/settings" class="block px-3 py-2 rounded hover:bg-gray-100">System Settings</a>
                    <a href="/admin/audit" class="block px-3 py-2 rounded hover:bg-gray-100">Audit Log</a>
                </div>
                {{end}}
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8">
            {{if .Flash}}
            <div class="mb-4 p-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded">
                {{.Flash}}
            </div>
            {{end}}

            {{template "content" .}}
        </main>
    </div>

    <script>
        // Helper for API calls with error handling
        async function apiCall(method, url, data) {
            try {
                const opts = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                };
                if (data) opts.body = JSON.stringify(data);
                const resp = await fetch(url, opts);
                if (!resp.ok) {
                    const errorText = await resp.text();
                    throw new Error(errorText || 'Request failed: ' + resp.status);
                }
                const contentType = resp.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return resp.json();
                }
                return { success: true };
            } catch (err) {
                alert('Error: ' + err.message);
                throw err;
            }
        }

        // Check for open tickets and update badge
        async function checkOpenTickets() {
            try {
                const response = await fetch('/api/admin/support/tickets/open-count', { credentials: 'same-origin' });
                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('ticket-badge');
                    if (badge) {
                        if (data.open_count > 0) {
                            badge.textContent = data.open_count;
                            badge.classList.remove('hidden');
                        } else {
                            badge.classList.add('hidden');
                        }
                    }
                }
            } catch (e) {}
        }

        // Check for unacknowledged errors and update badge
        async function checkUnacknowledgedErrors() {
            try {
                const response = await fetch('/api/admin/super/errors/unacknowledged-count', { credentials: 'same-origin' });
                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('error-badge');
                    if (badge) {
                        if (data.unacknowledged_count > 0) {
                            badge.textContent = data.unacknowledged_count;
                            badge.classList.remove('hidden');
                        } else {
                            badge.classList.add('hidden');
                        }
                    }
                }
            } catch (e) {}
        }

        // Poll for open tickets and unacknowledged errors on page load and every 30 seconds
        document.addEventListener('DOMContentLoaded', function() {
            checkOpenTickets();
            checkUnacknowledgedErrors();
            setInterval(checkOpenTickets, 30000);
            setInterval(checkUnacknowledgedErrors, 30000);
        });
    </script>
</body>
</html>
{{end}}
