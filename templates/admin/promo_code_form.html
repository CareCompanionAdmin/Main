{{define "content"}}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{if .Data.Data.promo}}Edit Promo Code{{else}}Create Promo Code{{end}}</h1>
            <p class="text-sm text-gray-500 mt-1">{{if .Data.Data.promo}}Modify promo code settings{{else}}Create a new promotional code for customers{{end}}</p>
        </div>
        <a href="/admin/promo-codes" class="px-4 py-2 border rounded-lg hover:bg-gray-100 flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            <span>Back to List</span>
        </a>
    </div>

    {{if not .Data.Data.promo}}
    <!-- Quick Presets (for new codes only) -->
    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg shadow p-6 border border-indigo-100">
        <h2 class="text-lg font-semibold mb-3">Quick Presets</h2>
        <p class="text-sm text-gray-600 mb-4">Click a preset to auto-fill common promo configurations:</p>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <button type="button" onclick="applyPreset('first_month_free')" class="p-3 bg-white rounded-lg border-2 border-transparent hover:border-indigo-300 shadow-sm text-left transition-all">
                <div class="text-indigo-600 font-semibold">First Month Free</div>
                <div class="text-xs text-gray-500">1 month free trial</div>
            </button>
            <button type="button" onclick="applyPreset('percent_off_50')" class="p-3 bg-white rounded-lg border-2 border-transparent hover:border-indigo-300 shadow-sm text-left transition-all">
                <div class="text-blue-600 font-semibold">50% Off</div>
                <div class="text-xs text-gray-500">First payment only</div>
            </button>
            <button type="button" onclick="applyPreset('percent_off_25')" class="p-3 bg-white rounded-lg border-2 border-transparent hover:border-indigo-300 shadow-sm text-left transition-all">
                <div class="text-green-600 font-semibold">25% Off</div>
                <div class="text-xs text-gray-500">First payment only</div>
            </button>
            <button type="button" onclick="applyPreset('referral')" class="p-3 bg-white rounded-lg border-2 border-transparent hover:border-indigo-300 shadow-sm text-left transition-all">
                <div class="text-purple-600 font-semibold">Referral Reward</div>
                <div class="text-xs text-gray-500">$5 off, 1 use per user</div>
            </button>
        </div>
    </div>
    {{end}}

    <form id="promo-form" class="space-y-6">
        <!-- Code & Basic Info -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                </svg>
                Code Information
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Promo Code *</label>
                    <div class="flex space-x-2">
                        <div class="flex-1 relative">
                            <input type="text" id="prefix" placeholder="PREFIX"
                                   class="w-24 border rounded-l-lg p-2 uppercase text-center font-mono bg-gray-50"
                                   value="{{if .Data.promo}}{{.Data.promo.Code}}{{end}}"
                                   {{if .Data.promo}}disabled{{end}}
                                   maxlength="10">
                            <span class="absolute top-2 right-0 text-gray-400 font-mono">-</span>
                        </div>
                        <input type="text" id="code" name="code" required
                               class="flex-1 border rounded-r-lg p-2 uppercase font-mono tracking-wider"
                               placeholder="XXXXXXXX"
                               value="{{if .Data.promo}}{{.Data.promo.Code}}{{end}}"
                               {{if .Data.promo}}disabled{{end}}
                               readonly>
                        {{if not .Data.promo}}
                        <button type="button" onclick="generateCode()" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            <span>Generate</span>
                        </button>
                        {{end}}
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Format: PREFIX-XXXXXXXX (auto-generated)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Display Name *</label>
                    <input type="text" id="name" name="name" required
                           class="w-full border rounded-lg p-2"
                           placeholder="e.g., Summer 2026 Promotion"
                           value="{{if .Data.promo}}{{.Data.promo.Name}}{{end}}">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium mb-1">Internal Description</label>
                    <textarea id="description" name="description" rows="2"
                              class="w-full border rounded-lg p-2"
                              placeholder="Internal notes about this promo code (not shown to customers)">{{if .Data.promo}}{{.Data.promo.Description}}{{end}}</textarea>
                </div>
            </div>
        </div>

        <!-- Discount Configuration -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Discount Configuration
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium mb-1">Discount Type *</label>
                    <select id="discount_type" name="discount_type" required class="w-full border rounded-lg p-2" onchange="updateDiscountUI()">
                        <option value="percentage" {{if and .Data.promo (eq .Data.promo.DiscountType "percentage")}}selected{{end}}>Percentage Off</option>
                        <option value="fixed_amount" {{if and .Data.promo (eq .Data.promo.DiscountType "fixed_amount")}}selected{{end}}>Fixed Amount Off</option>
                        <option value="free_trial_days" {{if and .Data.promo (eq .Data.promo.DiscountType "free_trial_days")}}selected{{end}}>Free Trial Days</option>
                        <option value="free_months" {{if and .Data.promo (eq .Data.promo.DiscountType "free_months")}}selected{{end}}>Free Months</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">
                        <span id="value-label">Value</span> *
                    </label>
                    <div class="relative">
                        <span id="value-prefix" class="absolute left-3 top-2 text-gray-500 font-medium"></span>
                        <input type="number" id="discount_value" name="discount_value" required
                               class="w-full border rounded-lg p-2 pl-8"
                               step="0.01" min="0"
                               value="{{if .Data.promo}}{{.Data.promo.DiscountValue}}{{end}}"
                               oninput="updateDiscountPreview()">
                        <span id="value-suffix" class="absolute right-3 top-2 text-gray-500 font-medium"></span>
                    </div>
                </div>
                <div id="max-discount-container">
                    <label class="block text-sm font-medium mb-1">Max Discount</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2 text-gray-500">$</span>
                        <input type="number" id="max_discount_cents" name="max_discount_cents"
                               class="w-full border rounded-lg p-2 pl-8"
                               placeholder="No limit"
                               step="1" min="0"
                               value="{{if .Data.promo}}{{.Data.promo.MaxDiscountCents}}{{end}}"
                               oninput="updateDiscountPreview()">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Optional cap for % discounts (in cents)</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Applies To</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                            <input type="radio" name="applies_to" value="both" class="mr-2"
                                   {{if or (not .Data.promo) (eq .Data.promo.AppliesTo "both")}}checked{{end}}>
                            <span>All Purchases</span>
                        </label>
                        <label class="flex items-center px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                            <input type="radio" name="applies_to" value="subscription" class="mr-2"
                                   {{if and .Data.promo (eq .Data.promo.AppliesTo "subscription")}}checked{{end}}>
                            <span>Subscriptions Only</span>
                        </label>
                    </div>
                </div>
                <div id="duration-container">
                    <label class="block text-sm font-medium mb-2">Discount Duration</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                            <input type="radio" name="duration_type" value="once" class="mr-2"
                                   {{if or (not .Data.promo) (not .Data.promo.DurationMonths)}}checked{{end}}
                                   onchange="toggleDurationMonths()">
                            <span>First payment</span>
                        </label>
                        <label class="flex items-center px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                            <input type="radio" name="duration_type" value="forever" class="mr-2"
                                   {{if and .Data.promo (eq .Data.promo.DurationMonths -1)}}checked{{end}}
                                   onchange="toggleDurationMonths()">
                            <span>Forever</span>
                        </label>
                        <label class="flex items-center px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                            <input type="radio" name="duration_type" value="months" class="mr-2"
                                   {{if and .Data.promo (gt .Data.promo.DurationMonths 0)}}checked{{end}}
                                   onchange="toggleDurationMonths()">
                            <input type="number" id="duration_months" name="duration_months"
                                   class="w-16 border rounded p-1 mx-1"
                                   min="1" max="24" placeholder="3"
                                   value="{{if and .Data.promo (gt .Data.promo.DurationMonths 0)}}{{.Data.promo.DurationMonths}}{{end}}"
                                   {{if or (not .Data.promo) (le .Data.promo.DurationMonths 0)}}disabled{{end}}
                                   oninput="updateDiscountPreview()">
                            <span>months</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Preview -->
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg shadow p-6 border border-green-200">
            <h2 class="text-lg font-semibold mb-3 flex items-center text-green-800">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                Live Preview
            </h2>
            <div id="discount-preview" class="bg-white rounded-lg p-4 border border-green-200">
                <p class="text-gray-500">Configure the discount to see a preview...</p>
            </div>
        </div>

        <!-- Usage Limits -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                Usage Limits
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Max Total Uses</label>
                    <input type="number" id="max_total_uses" name="max_total_uses"
                           class="w-full border rounded-lg p-2"
                           min="0" placeholder="Unlimited"
                           value="{{if .Data.promo}}{{.Data.promo.MaxTotalUses}}{{end}}">
                    <p class="text-xs text-gray-500 mt-1">Leave empty for unlimited uses</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Max Uses Per Customer</label>
                    <input type="number" id="max_uses_per_user" name="max_uses_per_user"
                           class="w-full border rounded-lg p-2"
                           min="1" value="{{if .Data.promo}}{{.Data.promo.MaxUsesPerUser}}{{else}}1{{end}}">
                </div>
            </div>
        </div>

        <!-- User Eligibility -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                User Eligibility
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Who Can Use This Code?</label>
                    <div class="space-y-2">
                        <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="user_type" value="all" class="mr-2"
                                   {{if or (not .Data.promo) (and (not .Data.promo.NewUsersOnly) (not .Data.promo.ExistingUsersOnly))}}checked{{end}}>
                            <div>
                                <span class="font-medium">All Users</span>
                                <p class="text-xs text-gray-500">Anyone can use this code</p>
                            </div>
                        </label>
                        <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="user_type" value="new" class="mr-2"
                                   {{if and .Data.promo .Data.promo.NewUsersOnly}}checked{{end}}>
                            <div>
                                <span class="font-medium">New Users Only</span>
                                <p class="text-xs text-gray-500">First-time subscribers only</p>
                            </div>
                        </label>
                        <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="user_type" value="existing" class="mr-2"
                                   {{if and .Data.promo .Data.promo.ExistingUsersOnly}}checked{{end}}>
                            <div>
                                <span class="font-medium">Existing Users Only</span>
                                <p class="text-xs text-gray-500">Current subscribers only</p>
                            </div>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Restrict to Email Domains</label>
                    <input type="text" id="email_domains" name="email_domains"
                           class="w-full border rounded-lg p-2"
                           placeholder="e.g., company.com, .edu"
                           value="{{if .Data.promo}}{{join .Data.promo.SpecificEmailDomains ", "}}{{end}}">
                    <p class="text-xs text-gray-500 mt-1">Comma-separated, leave empty for all</p>
                </div>
            </div>
        </div>

        <!-- Validity Period -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Validity Period
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Start Date</label>
                    <input type="datetime-local" id="starts_at" name="starts_at"
                           class="w-full border rounded-lg p-2"
                           value="{{if .Data.promo}}{{formatDateTime .Data.promo.StartsAt}}{{end}}">
                    <p class="text-xs text-gray-500 mt-1">Defaults to now if empty</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Expiration Date</label>
                    <input type="datetime-local" id="expires_at" name="expires_at"
                           class="w-full border rounded-lg p-2"
                           value="{{if .Data.promo}}{{formatDateTime .Data.promo.ExpiresAt}}{{end}}">
                    <p class="text-xs text-gray-500 mt-1">Leave empty for no expiration</p>
                </div>
            </div>
        </div>

        <!-- Campaign Tracking -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
                </svg>
                Campaign Tracking (Optional)
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Campaign Name</label>
                    <input type="text" id="campaign_name" name="campaign_name"
                           class="w-full border rounded-lg p-2"
                           placeholder="e.g., Summer 2026"
                           value="{{if .Data.promo}}{{.Data.promo.CampaignName}}{{end}}">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Campaign Source</label>
                    <select id="campaign_source" name="campaign_source" class="w-full border rounded-lg p-2">
                        <option value="">-- Select Source --</option>
                        <option value="email" {{if and .Data.promo (eq .Data.promo.CampaignSource "email")}}selected{{end}}>Email Marketing</option>
                        <option value="social" {{if and .Data.promo (eq .Data.promo.CampaignSource "social")}}selected{{end}}>Social Media</option>
                        <option value="referral" {{if and .Data.promo (eq .Data.promo.CampaignSource "referral")}}selected{{end}}>Referral Program</option>
                        <option value="partner" {{if and .Data.promo (eq .Data.promo.CampaignSource "partner")}}selected{{end}}>Partner</option>
                        <option value="influencer" {{if and .Data.promo (eq .Data.promo.CampaignSource "influencer")}}selected{{end}}>Influencer</option>
                        <option value="press" {{if and .Data.promo (eq .Data.promo.CampaignSource "press")}}selected{{end}}>Press/Media</option>
                        <option value="event" {{if and .Data.promo (eq .Data.promo.CampaignSource "event")}}selected{{end}}>Event</option>
                        <option value="internal" {{if and .Data.promo (eq .Data.promo.CampaignSource "internal")}}selected{{end}}>Internal/Employee</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-between items-center">
            <a href="/admin/promo-codes" class="px-6 py-3 border rounded-lg hover:bg-gray-100 flex items-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                <span>Cancel</span>
            </a>
            <button type="submit" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                <span>{{if .Data.promo}}Update Promo Code{{else}}Create Promo Code{{end}}</span>
            </button>
        </div>
    </form>
</div>

<script>
    const isEdit = {{if .Data.promo}}true{{else}}false{{end}};
    const promoCodeId = '{{if .Data.promo}}{{.Data.promo.ID}}{{end}}';

    // CareCompanion pricing
    const MONTHLY_PRICE_CENTS = 999; // $9.99
    const MONTHLY_PRICE = 9.99;

    // Preset configurations
    const presets = {
        first_month_free: {
            prefix: 'FIRST',
            name: 'First Month Free',
            discount_type: 'free_months',
            discount_value: 1,
            applies_to: 'subscription',
            user_type: 'new',
            max_uses_per_user: 1
        },
        percent_off_50: {
            prefix: 'HALF',
            name: '50% Off First Month',
            discount_type: 'percentage',
            discount_value: 50,
            applies_to: 'subscription',
            user_type: 'all',
            duration_type: 'once'
        },
        percent_off_25: {
            prefix: 'SAVE',
            name: '25% Off First Month',
            discount_type: 'percentage',
            discount_value: 25,
            applies_to: 'subscription',
            user_type: 'all',
            duration_type: 'once'
        },
        referral: {
            prefix: 'REFER',
            name: 'Referral Reward',
            discount_type: 'fixed_amount',
            discount_value: 500, // $5.00 in cents
            applies_to: 'both',
            user_type: 'all',
            max_uses_per_user: 1
        }
    };

    function applyPreset(presetName) {
        const preset = presets[presetName];
        if (!preset) return;

        document.getElementById('prefix').value = preset.prefix;
        document.getElementById('name').value = preset.name;
        document.getElementById('discount_type').value = preset.discount_type;
        document.getElementById('discount_value').value = preset.discount_value;

        const appliesToRadios = document.querySelectorAll('input[name="applies_to"]');
        appliesToRadios.forEach(r => r.checked = r.value === preset.applies_to);

        const userTypeRadios = document.querySelectorAll('input[name="user_type"]');
        userTypeRadios.forEach(r => r.checked = r.value === preset.user_type);

        if (preset.duration_type) {
            const durationRadios = document.querySelectorAll('input[name="duration_type"]');
            durationRadios.forEach(r => r.checked = r.value === preset.duration_type);
        }

        if (preset.max_uses_per_user) {
            document.getElementById('max_uses_per_user').value = preset.max_uses_per_user;
        }

        generateCode();
        updateDiscountUI();
        updateDiscountPreview();
    }

    function generateCode() {
        const prefix = document.getElementById('prefix').value.toUpperCase() || 'PROMO';
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let suffix = '';
        for (let i = 0; i < 8; i++) {
            suffix += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('code').value = prefix + '-' + suffix;
    }

    function updateDiscountUI() {
        const type = document.getElementById('discount_type').value;
        const prefix = document.getElementById('value-prefix');
        const suffix = document.getElementById('value-suffix');
        const label = document.getElementById('value-label');
        const maxContainer = document.getElementById('max-discount-container');
        const durationContainer = document.getElementById('duration-container');

        // Show/hide max discount (only for percentage)
        maxContainer.style.display = type === 'percentage' ? 'block' : 'none';

        // Show/hide duration (only for percentage and fixed_amount)
        durationContainer.style.display = (type === 'percentage' || type === 'fixed_amount') ? 'block' : 'none';

        switch (type) {
            case 'percentage':
                prefix.textContent = '';
                suffix.textContent = '%';
                label.textContent = 'Percentage';
                break;
            case 'fixed_amount':
                prefix.textContent = '$';
                suffix.textContent = '';
                label.textContent = 'Amount (cents)';
                break;
            case 'free_trial_days':
                prefix.textContent = '';
                suffix.textContent = 'days';
                label.textContent = 'Trial Days';
                break;
            case 'free_months':
                prefix.textContent = '';
                suffix.textContent = 'months';
                label.textContent = 'Free Months';
                break;
        }

        updateDiscountPreview();
    }

    function updateDiscountPreview() {
        const type = document.getElementById('discount_type').value;
        const value = parseFloat(document.getElementById('discount_value').value) || 0;
        const maxDiscount = parseInt(document.getElementById('max_discount_cents').value) || 0;
        const durationType = document.querySelector('input[name="duration_type"]:checked')?.value || 'once';
        const durationMonths = parseInt(document.getElementById('duration_months').value) || 0;
        const preview = document.getElementById('discount-preview');

        if (value <= 0) {
            preview.innerHTML = '<p class="text-gray-500">Enter a discount value to see the preview...</p>';
            return;
        }

        let html = '';
        let discountAmount = 0;
        let customerPays = MONTHLY_PRICE_CENTS;
        let savings = 0;

        switch (type) {
            case 'percentage':
                discountAmount = Math.round(MONTHLY_PRICE_CENTS * (value / 100));
                if (maxDiscount > 0 && discountAmount > maxDiscount) {
                    discountAmount = maxDiscount;
                }
                customerPays = MONTHLY_PRICE_CENTS - discountAmount;
                savings = discountAmount;

                let durationText = 'on their first payment';
                if (durationType === 'forever') {
                    durationText = 'on every payment (forever)';
                } else if (durationType === 'months' && durationMonths > 0) {
                    durationText = `for ${durationMonths} month${durationMonths > 1 ? 's' : ''}`;
                    savings = discountAmount * durationMonths;
                }

                html = `
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <span class="text-3xl font-bold text-green-600">${value}% OFF</span>
                            <p class="text-sm text-gray-500">${durationText}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500 line-through">$${MONTHLY_PRICE.toFixed(2)}/mo</div>
                            <div class="text-2xl font-bold">$${(customerPays / 100).toFixed(2)}<span class="text-sm text-gray-500">/mo</span></div>
                        </div>
                    </div>
                    <div class="bg-green-100 rounded-lg p-3 text-sm">
                        <strong>Customer saves:</strong> $${(savings / 100).toFixed(2)}${durationType !== 'once' ? ' total' : ''}
                        ${maxDiscount > 0 ? `<br><span class="text-gray-600">Max discount capped at $${(maxDiscount / 100).toFixed(2)}</span>` : ''}
                    </div>
                `;
                break;

            case 'fixed_amount':
                discountAmount = Math.min(value, MONTHLY_PRICE_CENTS);
                customerPays = MONTHLY_PRICE_CENTS - discountAmount;

                html = `
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <span class="text-3xl font-bold text-green-600">$${(value / 100).toFixed(2)} OFF</span>
                            <p class="text-sm text-gray-500">Fixed discount</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500 line-through">$${MONTHLY_PRICE.toFixed(2)}/mo</div>
                            <div class="text-2xl font-bold">$${(customerPays / 100).toFixed(2)}<span class="text-sm text-gray-500">/mo</span></div>
                        </div>
                    </div>
                    <div class="bg-green-100 rounded-lg p-3 text-sm">
                        <strong>Customer saves:</strong> $${(discountAmount / 100).toFixed(2)} on first payment
                    </div>
                `;
                break;

            case 'free_trial_days':
                html = `
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <span class="text-3xl font-bold text-purple-600">${value} DAYS FREE</span>
                            <p class="text-sm text-gray-500">Extended trial period</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-purple-600">Free Trial</div>
                            <div class="text-sm text-gray-500">Then $${MONTHLY_PRICE.toFixed(2)}/mo</div>
                        </div>
                    </div>
                    <div class="bg-purple-100 rounded-lg p-3 text-sm">
                        Customer gets <strong>${value} days</strong> to try CareCompanion before their first payment.
                    </div>
                `;
                break;

            case 'free_months':
                savings = value * MONTHLY_PRICE_CENTS;
                html = `
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <span class="text-3xl font-bold text-amber-600">${value} MONTH${value > 1 ? 'S' : ''} FREE</span>
                            <p class="text-sm text-gray-500">${value} payment${value > 1 ? 's' : ''} waived</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-amber-600">$0.00</div>
                            <div class="text-sm text-gray-500">for ${value} month${value > 1 ? 's' : ''}</div>
                        </div>
                    </div>
                    <div class="bg-amber-100 rounded-lg p-3 text-sm">
                        <strong>Customer saves:</strong> $${(savings / 100).toFixed(2)} (${value} Ã— $${MONTHLY_PRICE.toFixed(2)})
                    </div>
                `;
                break;
        }

        preview.innerHTML = html;
    }

    function toggleDurationMonths() {
        const monthsInput = document.getElementById('duration_months');
        const durationType = document.querySelector('input[name="duration_type"]:checked')?.value || 'once';
        monthsInput.disabled = durationType !== 'months';
        if (durationType !== 'months') {
            monthsInput.value = '';
        }
        updateDiscountPreview();
    }

    function collectFormData() {
        const form = document.getElementById('promo-form');
        const formData = new FormData(form);

        const code = isEdit ? promoCodeId : document.getElementById('code').value.toUpperCase();

        const data = {
            code: code,
            name: formData.get('name'),
            description: formData.get('description') || null,
            discount_type: formData.get('discount_type'),
            discount_value: parseFloat(formData.get('discount_value')),
            max_discount_cents: formData.get('max_discount_cents') ? parseInt(formData.get('max_discount_cents')) : null,
            applies_to: formData.get('applies_to'),
            minimum_purchase_cents: 0,
            max_total_uses: formData.get('max_total_uses') ? parseInt(formData.get('max_total_uses')) : null,
            max_uses_per_user: parseInt(formData.get('max_uses_per_user')) || 1,
            is_stackable: false,
            campaign_name: formData.get('campaign_name') || null,
            campaign_source: formData.get('campaign_source') || null
        };

        // User eligibility
        const userType = formData.get('user_type');
        data.new_users_only = userType === 'new';
        data.existing_users_only = userType === 'existing';

        // Email domains
        const emailDomains = formData.get('email_domains');
        if (emailDomains) {
            data.specific_email_domains = emailDomains.split(',').map(d => d.trim()).filter(d => d);
        }

        // Time constraints
        const startsAt = formData.get('starts_at');
        if (startsAt) {
            data.starts_at = new Date(startsAt).toISOString();
        }
        const expiresAt = formData.get('expires_at');
        if (expiresAt) {
            data.expires_at = new Date(expiresAt).toISOString();
        }

        // Duration
        const durationType = formData.get('duration_type');
        if (durationType === 'forever') {
            data.duration_months = -1;
        } else if (durationType === 'months') {
            data.duration_months = parseInt(formData.get('duration_months')) || null;
        }

        return data;
    }

    document.getElementById('promo-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const data = collectFormData();
        const url = isEdit ? `/api/admin/super/promo-codes/${promoCodeId}` : '/api/admin/super/promo-codes';
        const method = isEdit ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(error || 'Failed to save promo code');
            }

            window.location.href = '/admin/promo-codes';
        } catch (err) {
            alert('Error: ' + err.message);
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        updateDiscountUI();
        {{if not .Data.promo}}
        generateCode();
        {{end}}
    });
</script>
{{end}}
