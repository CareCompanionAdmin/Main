{{define "content"}}
<div class="mb-6">
    <a href="/admin/tickets" class="text-indigo-600 hover:text-indigo-800">&larr; Back to Tickets</a>
</div>

{{with .Data.ticket}}
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex justify-between items-start mb-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">{{.Subject}}</h1>
            <p class="text-sm text-gray-500">Ticket #{{slice .ID.String 0 8}} | Created {{.CreatedAt.Format "Jan 2, 2006 3:04 PM"}}</p>
        </div>
        <div class="flex space-x-2">
            <span class="px-3 py-1 text-sm rounded-full
                {{if eq .Priority "urgent"}}bg-red-100 text-red-800
                {{else if eq .Priority "high"}}bg-orange-100 text-orange-800
                {{else}}bg-blue-100 text-blue-800{{end}}">
                {{.Priority}}
            </span>
            <span class="px-3 py-1 text-sm rounded-full
                {{if eq .Status "open"}}bg-green-100 text-green-800
                {{else if eq .Status "resolved"}}bg-gray-100 text-gray-800
                {{else}}bg-yellow-100 text-yellow-800{{end}}">
                {{.Status}}
            </span>
        </div>
    </div>

    <div class="border-t pt-4 mb-4">
        <h3 class="text-sm font-medium text-gray-500 mb-2">Description</h3>
        <p class="text-gray-800 whitespace-pre-wrap">{{.Description}}</p>
    </div>

    <div class="border-t pt-4 flex justify-between items-center">
        <div class="text-sm text-gray-500">
            <span>User: {{if .UserEmail}}{{.UserEmail}}{{else}}N/A{{end}}</span>
            <span class="mx-2">|</span>
            <span>Assigned: {{if .AssigneeName}}{{.AssigneeName}}{{else}}Unassigned{{end}}</span>
        </div>
        <div class="flex space-x-2">
            {{if ne .Status "resolved"}}
            <button onclick="assignToMe('{{.ID}}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Assign to Me</button>
            <button onclick="resolveTicket('{{.ID}}')" class="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">Resolve</button>
            {{end}}
        </div>
    </div>
</div>
{{end}}

<!-- Messages -->
<div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-bold text-gray-800 mb-4">Messages</h2>

    <div class="space-y-4 mb-6 max-h-96 overflow-y-auto">
        {{range .Data.messages}}
        <div class="p-4 rounded {{if .IsInternal}}bg-yellow-50 border border-yellow-200{{else}}bg-gray-50{{end}}">
            <div class="flex justify-between text-sm mb-2">
                <span class="font-medium">{{.SenderName}} {{if .IsInternal}}<span class="text-yellow-600">(Internal)</span>{{end}}</span>
                <span class="text-gray-500">{{.CreatedAt.Format "Jan 2, 3:04 PM"}}</span>
            </div>
            <p class="text-gray-800 whitespace-pre-wrap">{{.Message}}</p>
        </div>
        {{else}}
        <p class="text-gray-500 text-center py-4">No messages yet</p>
        {{end}}
    </div>

    <!-- Add Message Form -->
    <form id="messageForm" class="border-t pt-4">
        <textarea id="message" rows="3" required placeholder="Type your message..."
                  class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500 focus:border-transparent"></textarea>
        <div class="flex justify-between items-center mt-3">
            <label class="flex items-center text-sm text-gray-600">
                <input type="checkbox" id="isInternal" class="mr-2">
                Internal note (not visible to user)
            </label>
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                Send Message
            </button>
        </div>
    </form>
</div>

<script>
const ticketId = '{{.Data.ticket.ID}}';

document.getElementById('messageForm').onsubmit = async (e) => {
    e.preventDefault();
    const message = document.getElementById('message').value;
    const isInternal = document.getElementById('isInternal').checked;
    await apiCall('POST', '/api/admin/support/tickets/' + ticketId + '/messages', { message, is_internal: isInternal });
    location.reload();
};

async function assignToMe(id) {
    // Get current user ID from somewhere or use endpoint that auto-assigns
    await apiCall('POST', '/api/admin/support/tickets/' + id + '/assign', { assignee_id: '{{$.CurrentUser.ID}}' });
    location.reload();
}

async function resolveTicket(id) {
    if (confirm('Mark this ticket as resolved?')) {
        await apiCall('POST', '/api/admin/support/tickets/' + id + '/resolve');
        location.reload();
    }
}
</script>
{{end}}
