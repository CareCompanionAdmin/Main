<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alert Analysis - CareCompanion</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">

<!-- Navigation -->
<nav class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center">
                <a href="/dashboard" class="text-xl font-bold text-indigo-600">CareCompanion</a>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/settings" class="text-gray-500 hover:text-gray-700" title="Settings">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </a>
                <button onclick="logout()" class="text-gray-500 hover:text-gray-700" title="Logout">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</nav>

{{template "mascot" .}}

<main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6">
        <a href="/child/{{.ChildID}}/alerts" class="text-indigo-600 hover:text-indigo-500 flex items-center">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to Alerts
        </a>
    </div>

    <!-- View Toggle -->
    <div class="bg-white rounded-xl shadow-sm border p-4 mb-6">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-900">Full Analysis</h1>
            <div class="flex bg-gray-100 rounded-lg p-1">
                <button id="view-parent" onclick="setViewMode('parent')" class="px-4 py-2 text-sm font-medium rounded-md bg-white shadow text-gray-900">
                    Parent View
                </button>
                <button id="view-clinical" onclick="setViewMode('clinical')" class="px-4 py-2 text-sm font-medium rounded-md text-gray-600 hover:text-gray-900">
                    Clinical View
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Summary -->
    <div id="alert-summary" class="bg-white rounded-xl shadow-sm border p-6 mb-6">
        <!-- Will be populated by JavaScript -->
        <div class="animate-pulse">
            <div class="h-6 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
            <div class="h-4 bg-gray-200 rounded w-5/6"></div>
        </div>
    </div>

    <!-- Confidence Breakdown Section -->
    <div class="bg-white rounded-xl shadow-sm border overflow-hidden mb-6">
        <div class="p-6 border-b bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-900">Confidence Breakdown</h2>
            <p class="text-sm text-gray-500">How this insight was calculated</p>
        </div>
        <div id="confidence-section" class="p-6">
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
            </div>
        </div>
    </div>

    <!-- Cohort Matching Section -->
    <div class="bg-white rounded-xl shadow-sm border overflow-hidden mb-6">
        <div class="p-6 border-b bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-900" id="cohort-title">Similar Families</h2>
            <p class="text-sm text-gray-500" id="cohort-subtitle">How your experience compares to others</p>
        </div>
        <div id="cohort-section" class="p-6">
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
            </div>
        </div>
    </div>

    <!-- Technical Details Section (Clinical View) -->
    <div id="technical-section" class="bg-white rounded-xl shadow-sm border overflow-hidden mb-6 hidden">
        <div class="p-6 border-b bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-900">Technical Analysis Details</h2>
            <p class="text-sm text-gray-500">Methodology and statistical measures</p>
        </div>
        <div id="technical-content" class="p-6">
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
            </div>
        </div>
    </div>

    <!-- Citations Section -->
    <div class="bg-white rounded-xl shadow-sm border overflow-hidden mb-6">
        <div class="p-6 border-b bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-900">References</h2>
            <p class="text-sm text-gray-500">Sources used in this analysis</p>
        </div>
        <div id="citations-section" class="p-6">
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
            </div>
        </div>
    </div>

    <!-- Actions Section -->
    <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Actions</h2>
        <div class="flex flex-wrap gap-3">
            <button onclick="exportAnalysis('pdf_download')" class="flex items-center px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Download PDF
            </button>
            <button onclick="exportAnalysis('share_to_provider')" class="flex items-center px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                </svg>
                Share with Provider
            </button>
            <button onclick="window.print()" class="flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                </svg>
                Print
            </button>
        </div>
    </div>

    <!-- Feedback Section -->
    <div class="bg-white rounded-xl shadow-sm border p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Was this analysis helpful?</h2>
        <div class="flex gap-4">
            <button onclick="submitFeedback(true)" class="flex items-center px-6 py-3 bg-green-50 text-green-700 rounded-lg hover:bg-green-100">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path>
                </svg>
                Yes, helpful
            </button>
            <button onclick="submitFeedback(false)" class="flex items-center px-6 py-3 bg-red-50 text-red-700 rounded-lg hover:bg-red-100">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.096c.5 0 .905-.405.905-.904 0-.715.211-1.413.608-2.008L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"></path>
                </svg>
                Not helpful
            </button>
        </div>
    </div>
</main>

<script>
const alertId = '{{.AlertID}}';
const childId = '{{.ChildID}}';
let currentViewMode = 'parent';
let analysisData = null;

// Terminology mapping for parent vs clinical view
const terminology = {
    parent: {
        cohortTitle: 'Similar Families',
        cohortSubtitle: 'How your experience compares to others',
        baselineMean: 'Typical value',
        baselineStddev: 'Normal range',
        deviationScore: 'How different from usual',
        confidenceInterval: 'Expected range',
        sampleSize: 'Based on observations'
    },
    clinical: {
        cohortTitle: 'Cohort Analysis',
        cohortSubtitle: 'Statistical comparison with matched cohorts',
        baselineMean: 'Baseline mean',
        baselineStddev: 'Standard deviation',
        deviationScore: 'Z-score',
        confidenceInterval: '95% confidence interval',
        sampleSize: 'n='
    }
};

document.addEventListener('DOMContentLoaded', loadAnalysis);

async function loadAnalysis() {
    try {
        const response = await fetch(`/api/alerts/${alertId}/analysis`, {
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error('Failed to load analysis');
        }

        analysisData = await response.json();
        renderAnalysis();
    } catch (error) {
        console.error('Error loading analysis:', error);
        document.getElementById('alert-summary').innerHTML = `
            <div class="text-center py-8 text-red-600">
                <p>Failed to load analysis. Please try again.</p>
            </div>
        `;
    }
}

function setViewMode(mode) {
    currentViewMode = mode;

    // Update button styles
    const parentBtn = document.getElementById('view-parent');
    const clinicalBtn = document.getElementById('view-clinical');

    if (mode === 'parent') {
        parentBtn.classList.add('bg-white', 'shadow', 'text-gray-900');
        parentBtn.classList.remove('text-gray-600');
        clinicalBtn.classList.remove('bg-white', 'shadow', 'text-gray-900');
        clinicalBtn.classList.add('text-gray-600');
        document.getElementById('technical-section').classList.add('hidden');
    } else {
        clinicalBtn.classList.add('bg-white', 'shadow', 'text-gray-900');
        clinicalBtn.classList.remove('text-gray-600');
        parentBtn.classList.remove('bg-white', 'shadow', 'text-gray-900');
        parentBtn.classList.add('text-gray-600');
        document.getElementById('technical-section').classList.remove('hidden');
    }

    // Update terminology
    const terms = terminology[mode];
    document.getElementById('cohort-title').textContent = terms.cohortTitle;
    document.getElementById('cohort-subtitle').textContent = terms.cohortSubtitle;

    if (analysisData) {
        renderAnalysis();
    }
}

function renderAnalysis() {
    if (!analysisData) return;

    const { alert, analysis_details, confidence_factors, cohort_matching, child_name } = analysisData;
    const terms = terminology[currentViewMode];

    // Render alert summary
    const summaryHtml = `
        <div class="flex items-start justify-between">
            <div>
                <div class="flex items-center space-x-2 mb-2">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${getSeverityClass(alert.severity)}">
                        ${alert.severity}
                    </span>
                    <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">${alert.alert_type}</span>
                </div>
                <h2 class="text-xl font-semibold text-gray-900">${alert.title}</h2>
                <p class="text-gray-600 mt-2">${alert.description}</p>
                <p class="text-sm text-gray-400 mt-2">For ${child_name || 'your child'} - ${formatDate(alert.created_at)}</p>
            </div>
            ${alert.confidence_score ? `
            <div class="text-center">
                <div class="text-2xl mb-1">${renderConfidenceDots(alert.confidence_score)}</div>
                <p class="text-sm text-gray-600">${(alert.confidence_score * 100).toFixed(0)}% confidence</p>
            </div>
            ` : ''}
        </div>
    `;
    document.getElementById('alert-summary').innerHTML = summaryHtml;

    // Render confidence factors
    renderConfidenceFactors(confidence_factors);

    // Render cohort matching
    renderCohortMatching(cohort_matching);

    // Render technical details (clinical view only)
    if (analysis_details) {
        renderTechnicalDetails(analysis_details, terms);
    }

    // Render citations
    renderCitations(confidence_factors);
}

function renderConfidenceFactors(factors) {
    const container = document.getElementById('confidence-section');

    if (!factors || factors.length === 0) {
        container.innerHTML = `
            <p class="text-gray-500 text-center py-4">Detailed confidence breakdown not yet available.</p>
        `;
        return;
    }

    container.innerHTML = factors.map(factor => `
        <div class="mb-4 last:mb-0">
            <div class="flex items-start bg-gray-50 rounded-lg p-4">
                <span class="text-2xl mr-4">${getFactorIcon(factor.factor_type)}</span>
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium text-gray-900">${getFactorLabel(factor.factor_type)}</span>
                        <span class="text-sm font-medium ${getContributionColor(factor.contribution)}">${(factor.contribution * 100).toFixed(0)}%</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${factor.description}</p>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-indigo-500 rounded-full transition-all" style="width: ${factor.contribution * 100}%"></div>
                    </div>
                    ${factor.cohort ? `
                    <p class="text-xs text-gray-500 mt-2">Based on ${factor.cohort_sample_size || 'multiple'} similar families</p>
                    ` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

function renderCohortMatching(cohortMatching) {
    const container = document.getElementById('cohort-section');

    if (!cohortMatching || cohortMatching.length === 0) {
        container.innerHTML = `
            <p class="text-gray-500 text-center py-4">No cohort matching data available for this alert.</p>
        `;
        return;
    }

    container.innerHTML = cohortMatching.map(match => `
        <div class="bg-gray-50 rounded-lg p-4 mb-4 last:mb-0">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h3 class="font-medium text-gray-900">${match.cohort?.name || 'Similar Group'}</h3>
                    <p class="text-sm text-gray-500">${match.cohort_size} families in this group</p>
                </div>
                <div class="text-right">
                    <div class="text-lg font-semibold text-indigo-600">${(match.confirmation_rate * 100).toFixed(0)}%</div>
                    <p class="text-xs text-gray-500">confirmation rate</p>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4 text-center text-sm">
                <div class="bg-green-50 rounded p-2">
                    <div class="font-medium text-green-700">${match.pattern_confirmations}</div>
                    <div class="text-gray-500">Confirmed</div>
                </div>
                <div class="bg-red-50 rounded p-2">
                    <div class="font-medium text-red-700">${match.pattern_denials}</div>
                    <div class="text-gray-500">Not seen</div>
                </div>
                <div class="bg-gray-100 rounded p-2">
                    <div class="font-medium text-gray-700">${match.pattern_no_response}</div>
                    <div class="text-gray-500">No response</div>
                </div>
            </div>
        </div>
    `).join('');
}

function renderTechnicalDetails(details, terms) {
    const container = document.getElementById('technical-content');

    // Get the appropriate view content based on current mode
    const viewContent = currentViewMode === 'clinical' ? details.clinical_view : details.parent_view;

    if (!viewContent && !details.data_points_used) {
        container.innerHTML = `
            <p class="text-gray-500 text-center py-4">Technical details not available for this analysis.</p>
        `;
        return;
    }

    let html = '<div class="space-y-6">';

    // Render view-specific content
    if (viewContent) {
        // Summary section
        if (viewContent.summary) {
            html += `
                <div>
                    <h3 class="font-medium text-gray-900 mb-2">Summary</h3>
                    <p class="text-gray-600">${viewContent.summary}</p>
                </div>
            `;
        }

        // Key findings (parent view)
        if (viewContent.key_findings && viewContent.key_findings.length > 0) {
            html += `
                <div>
                    <h3 class="font-medium text-gray-900 mb-2">Key Findings</h3>
                    <ul class="list-disc list-inside space-y-1 text-gray-600">
                        ${viewContent.key_findings.map(finding => `<li>${finding}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        // Methodology (clinical view)
        if (viewContent.methodology) {
            html += `
                <div>
                    <h3 class="font-medium text-gray-900 mb-2">Methodology</h3>
                    <p class="text-gray-600">${viewContent.methodology}</p>
                </div>
            `;
        }

        // Statistical Measures (clinical view)
        if (viewContent.statistical_measures) {
            html += `
                <div>
                    <h3 class="font-medium text-gray-900 mb-2">Statistical Measures</h3>
                    <div class="bg-blue-50 rounded-lg p-4">
                        <dl class="grid grid-cols-2 gap-4 text-sm">
                            ${Object.entries(viewContent.statistical_measures).map(([key, value]) => `
                                <div class="flex justify-between">
                                    <dt class="text-gray-600">${formatLabel(key)}</dt>
                                    <dd class="font-semibold text-blue-700">${
                                        Array.isArray(value)
                                            ? '[' + value.map(v => typeof v === 'number' ? v.toFixed(2) : v).join(', ') + ']'
                                            : (typeof value === 'number' ? value.toFixed(4) : value)
                                    }</dd>
                                </div>
                            `).join('')}
                        </dl>
                    </div>
                </div>
            `;
        }

        // Limitations (clinical view)
        if (viewContent.limitations && viewContent.limitations.length > 0) {
            html += `
                <div>
                    <h3 class="font-medium text-gray-900 mb-2">Limitations</h3>
                    <ul class="list-disc list-inside space-y-1 text-gray-600">
                        ${viewContent.limitations.map(lim => `<li>${lim}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        // Confidence intervals (clinical view)
        if (viewContent.confidence_intervals) {
            html += `
                <div>
                    <h3 class="font-medium text-gray-900 mb-2">Confidence Intervals</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <dl class="space-y-2 text-sm">
                            ${Object.entries(viewContent.confidence_intervals).map(([key, value]) => `
                                <div class="flex justify-between">
                                    <dt class="text-gray-500">${formatLabel(key)}</dt>
                                    <dd class="font-medium">${typeof value === 'number' ? value.toFixed(2) : value}</dd>
                                </div>
                            `).join('')}
                        </dl>
                    </div>
                </div>
            `;
        }
    }

    // Analysis metadata (always shown in clinical view)
    if (currentViewMode === 'clinical') {
        html += `
            <div class="pt-4 border-t">
                <h3 class="font-medium text-gray-900 mb-3">Analysis Metadata</h3>
                <div class="grid grid-cols-2 gap-4">
                    <dl class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <dt class="text-gray-500">Data points used</dt>
                            <dd class="font-medium">${details.data_points_used || 'N/A'}</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-gray-500">Analysis window</dt>
                            <dd class="font-medium">${details.analysis_window_days ? details.analysis_window_days + ' days' : 'N/A'}</dd>
                        </div>
                    </dl>
                    <dl class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <dt class="text-gray-500">Algorithm version</dt>
                            <dd class="font-medium">${details.algorithm_version || 'v1.0'}</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-gray-500">Processing time</dt>
                            <dd class="font-medium">${details.processing_time_ms ? details.processing_time_ms + 'ms' : 'N/A'}</dd>
                        </div>
                    </dl>
                </div>
            </div>
        `;
    }

    html += '</div>';
    container.innerHTML = html;
}

function formatLabel(key) {
    return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

function renderCitations(factors) {
    const container = document.getElementById('citations-section');
    const citations = factors?.filter(f => f.citation).map(f => f.citation) || [];

    if (citations.length === 0) {
        container.innerHTML = `
            <p class="text-gray-500 text-center py-4">No external references used for this analysis.</p>
        `;
        return;
    }

    container.innerHTML = citations.map(citation => `
        <div class="border-l-4 border-indigo-500 pl-4 py-2 mb-4 last:mb-0">
            <p class="font-medium text-gray-900">${citation.publication_title}</p>
            <p class="text-sm text-gray-600">${citation.authority_name}</p>
            ${citation.url ? `
            <a href="${citation.url}" target="_blank" class="text-sm text-indigo-600 hover:underline">View source</a>
            ` : ''}
        </div>
    `).join('');
}

function renderConfidenceDots(score) {
    const filled = Math.round(score * 5);
    let html = '';
    let colorClass = score >= 0.7 ? 'text-green-500' : score >= 0.4 ? 'text-yellow-500' : 'text-red-500';

    for (let i = 0; i < 5; i++) {
        html += i < filled
            ? `<span class="${colorClass}">‚óè</span>`
            : '<span class="text-gray-300">‚óã</span>';
    }
    return html;
}

function getSeverityClass(severity) {
    switch (severity) {
        case 'critical': return 'bg-red-100 text-red-700';
        case 'warning': return 'bg-yellow-100 text-yellow-700';
        default: return 'bg-blue-100 text-blue-700';
    }
}

function getFactorIcon(type) {
    const icons = {
        'global_medical': 'üìö',
        'family_history': 'üìã',
        'cohort_pattern': 'üë•',
        'temporal_proximity': '‚è±Ô∏è',
        'clinical_validation': '‚úÖ',
        'amplitude': 'üìà',
        'medication_criticality': 'üíä'
    };
    return icons[type] || 'üìä';
}

function getFactorLabel(type) {
    const labels = {
        'global_medical': 'Medical Reference',
        'family_history': "Your Child's History",
        'cohort_pattern': 'Similar Families',
        'temporal_proximity': 'Timing Match',
        'clinical_validation': 'Clinically Validated',
        'amplitude': 'Change Magnitude',
        'medication_criticality': 'Medication Importance'
    };
    return labels[type] || 'Analysis Factor';
}

function getContributionColor(contribution) {
    if (contribution >= 0.3) return 'text-green-600';
    if (contribution >= 0.15) return 'text-yellow-600';
    return 'text-gray-600';
}

function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
    });
}

async function exportAnalysis(exportType) {
    try {
        const response = await fetch(`/api/alerts/${alertId}/export`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                export_type: exportType,
                view_mode: currentViewMode
            })
        });

        if (response.ok) {
            if (exportType === 'pdf_download') {
                alert('PDF export would be generated here. Feature coming soon!');
            } else if (exportType === 'share_to_provider') {
                alert('Share functionality coming soon!');
            }
        } else {
            alert('Failed to create export');
        }
    } catch (error) {
        console.error('Export error:', error);
        alert('Failed to create export');
    }
}

async function submitFeedback(helpful) {
    try {
        const response = await fetch(`/api/alerts/${alertId}/feedback`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ was_helpful: helpful })
        });

        if (response.ok) {
            alert('Thank you for your feedback!');
        } else {
            alert('Failed to submit feedback');
        }
    } catch (error) {
        console.error('Feedback error:', error);
        alert('Failed to submit feedback');
    }
}

function logout() {
    localStorage.removeItem('access_token');
    localStorage.removeItem('refresh_token');
    document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
    document.cookie = 'refresh_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
    window.location.href = '/login';
}
</script>
</body>
</html>
